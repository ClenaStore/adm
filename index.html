<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Painel ‚Ä¢ Rifa Solid√°ria</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0b1220;--card:#0f172a;--ink:#eaf2ff;--muted:#95a3be;--line:#1f2a41;--ok:#16a34a;--warn:#f59e0b;--bad:#ef4444;}
  *{box-sizing:border-box;font-family:Inter,system-ui}
  body{margin:0;background:radial-gradient(circle at 20% -10%,#162751,#0b1120 70%);color:var(--ink)}
  header{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center}
  h1{margin:0;font-size:18px}
  button,select{border:0;border-radius:8px}
  .refresh{margin-left:auto;background:linear-gradient(90deg,#00e5ff,#7c3aed);padding:10px 14px;color:#fff;cursor:pointer}
  main{padding:16px}
  .msg{margin-bottom:10px;font-weight:600}
  .table{width:100%;border-collapse:collapse;background:var(--card);border:1px solid var(--line);box-shadow:0 6px 18px rgba(0,0,0,.25);border-radius:12px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid var(--line);font-size:14px}
  th{background:#0c1830;text-align:left;color:#cfe3ff}
  tr:last-child td{border-bottom:0}
  .status{padding:4px 8px;border-radius:6px;font-weight:700;font-size:12px}
  .S-RESERVADO{background:#22314a;color:#ffd88a}
  .S-PAGO{background:#153a2a;color:#bdfcc5}
  .S-CANCELADO{background:#3b1c1c;color:#ff9e9e}
  .S-ENTREGUE{background:#133042;color:#aee9ff}
  .row-actions{display:flex;gap:6px;align-items:center}
  .sel{background:#0f1e3d;color:#fff;border:1px solid #1f335e;padding:6px 8px}
  .salvar{background:var(--ok);color:#fff;padding:7px 10px;cursor:pointer}
</style>
</head>
<body>
<header>
  <h1>üéüÔ∏è Painel da Rifa Solid√°ria</h1>
  <button class="refresh" onclick="load()">üîÑ Atualizar</button>
</header>
<main>
  <div id="msg" class="msg"></div>
  <div style="overflow:auto">
    <table class="table">
      <thead>
        <tr>
          <th>#</th><th>Nome</th><th>Telefone</th><th>Email</th>
          <th>N√∫meros</th><th>Qtd</th><th>Total</th><th>Data/Hora</th>
          <th>Status</th><th>Mudar status</th>
        </tr>
      </thead>
      <tbody id="body"><tr><td colspan="10">Carregando...</td></tr></tbody>
    </table>
  </div>
</main>

<script>
  // üîó Cole aqui o link /exec do seu GAS
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxV6noIXFBPSaCamkpSJDeDITLErD2B_PjwPYVA0aBL36BgRpWSbVtQzA99uprmSYA8vQ/exec";

  let DATA = [];

  function toast(t, error=false){
    const el = document.getElementById('msg');
    el.style.color = error ? "#ff6b81" : "#7af59a";
    el.textContent = t;
    if(t) setTimeout(()=> el.textContent='', 3000);
  }

  // ---- JSONP helper (Promise) ----
  function jsonp(url){
    return new Promise((resolve, reject)=>{
      const cb = "cb_"+Math.random().toString(36).slice(2);
      window[cb] = (payload)=>{ resolve(payload); cleanup(); };
      const s = document.createElement('script');
      s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
      s.onerror = ()=>{ reject(new Error("JSONP error")); cleanup(); };
      document.body.appendChild(s);
      function cleanup(){ try{delete window[cb]}catch{}; s.remove(); }
    });
  }

  async function load(){
    document.getElementById('body').innerHTML = "<tr><td colspan='10'>Carregando...</td></tr>";
    try{
      const rows = await jsonp(`${SCRIPT_URL}?action=list`);
      DATA = Array.isArray(rows) ? rows : [];
      render(DATA);
      toast("Registros carregados");
    }catch(e){
      document.getElementById('body').innerHTML = "<tr><td colspan='10'>Falha ao carregar</td></tr>";
      toast(e.message,true);
    }
  }

  function render(rows){
    const tbody = document.getElementById('body');
    if(!rows.length){ tbody.innerHTML = "<tr><td colspan='10'>Nenhum registro</td></tr>"; return; }
    tbody.innerHTML = rows.map(r=>{
      const sclass = "S-" + String(r.status||"").toUpperCase();
      return `<tr>
        <td>${r.rowNumber}</td>
        <td>${esc(r.nome)}</td>
        <td>${esc(r.telefone)}</td>
        <td>${esc(r.email)}</td>
        <td>${esc(r.numeros)}</td>
        <td>${esc(r.qtd)}</td>
        <td>${esc(r.total)}</td>
        <td>${esc(r.dataHora)}</td>
        <td><span class="status ${sclass}">${esc(r.status||"")}</span></td>
        <td class="row-actions">
          <select id="sel-${r.rowNumber}" class="sel">
            ${opt("RESERVADO", r.status)}
            ${opt("PAGO", r.status)}
            ${opt("CANCELADO", r.status)}
            ${opt("ENTREGUE", r.status)}
          </select>
          <button class="salvar" onclick="save(${r.rowNumber})">Salvar</button>
        </td>
      </tr>`;
    }).join('');
  }

  function opt(v, cur){ return `<option value="${v}" ${String(cur).toUpperCase()===v?"selected":""}>${v}</option>`; }
  function esc(s){ return String(s??"").replace(/[&<>"]/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[m])); }

  async function save(rowNumber){
    const status = document.getElementById(`sel-${rowNumber}`).value;
    try{
      const res = await jsonp(`${SCRIPT_URL}?action=update&row=${rowNumber}&status=${encodeURIComponent(status)}`);
      if(res && res.ok){ toast("Status atualizado"); load(); }
      else { toast(res && res.error ? res.error : "Falha ao atualizar", true); }
    }catch(e){ toast(e.message, true); }
  }

  load();
</script>
</body>
</html>
